<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
          @if (feedType === 'following') {
            <span>Following Feed</span>
          }
          @if (feedType === 'user' && !userId) {
            <span>My Activity</span>
          }
          @if (feedType === 'user' && userId) {
            <span>
              User Activity
              <a [href]="`https://anilist.co/user/${userId}`" target="_blank">
                <myanili-icon name="box-arrow-up-right"></myanili-icon>
              </a>
            </span>
          }
        </h2>
        @if (!activityId) {
          <div class="d-flex gap-2">
            <div class="btn-group">
              <button
                class="btn btn-sm"
                [class.btn-primary]="feedType === 'user' && !userId"
                [class.btn-outline-primary]="feedType !== 'user' || userId"
                (click)="feedType = 'user'; userId = undefined; loadFeed()"
              >
                <myanili-icon
                  [name]="feedType === 'user' && !userId ? 'person-fill' : 'person'"
                ></myanili-icon>
                <span class="d-none d-md-inline ms-1">My Feed</span>
              </button>
              <button
                class="btn btn-sm"
                [class.btn-primary]="feedType === 'following'"
                [class.btn-outline-primary]="feedType !== 'following'"
                (click)="feedType = 'following'; loadFeed()"
              >
                <myanili-icon
                  [name]="feedType === 'following' ? 'people-fill' : 'people'"
                ></myanili-icon>
                <span class="d-none d-md-inline ms-1">Following Feed</span>
              </button>
            </div>
            <button
              class="btn btn-sm btn-outline-primary"
              (click)="reloadFeed()"
              [disabled]="loading"
            >
              <myanili-icon name="arrow-clockwise"></myanili-icon>
              <span class="d-none d-md-inline ms-1">Reload</span>
            </button>
          </div>
        }
      </div>

      @if (loading) {
        <div class="text-center py-5">
          <myanili-icon-loading size="3em">
            <span class="visually-hidden">Loading...</span>
          </myanili-icon-loading>
        </div>
      }

      @if (!loading && activities.length === 0) {
        <div class="alert alert-info">No activities found.</div>
      }
      @if (activities.length > 0 && !loading) {
        <div class="activities">
          @for (activity of activities; track activity) {
            <div class="mb-3">
              <div class="card shadow-sm overflow-hidden">
                <div class="card-body">
                  <div class="d-flex align-items-start gap-3">
                    <img
                      [src]="activity.user.avatar.medium"
                      class="rounded-circle"
                      width="48"
                      height="48"
                      alt="{{ activity.user.name }}"
                      [routerLink]="['/feed/user', activity.user.id]"
                      style="cursor: pointer"
                    />
                    <div class="flex-grow-1" style="min-width: 0">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <strong
                            [routerLink]="['/feed/user', activity.user.id]"
                            style="cursor: pointer"
                          >
                            {{ activity.user.name }}
                          </strong>
                          <small class="text-muted ms-2">{{
                            formatDate(activity.createdAt)
                          }}</small>
                        </div>
                        <a [href]="activity.siteUrl" target="_blank" class="btn btn-sm btn-link">
                          <myanili-icon name="box-arrow-up-right"></myanili-icon>
                        </a>
                      </div>
                      <div
                        class="mt-2 lh-base activity-text clamped"
                        [innerHTML]="getActivityText(activity)"
                      ></div>
                      @if (activity.media) {
                        <div
                          class="mt-2 rounded d-flex align-items-center"
                          [class.cursor-pointer]="activity.media.idMal"
                          (click)="navigateToMedia(activity.media)"
                          style="cursor: pointer"
                        >
                          <img
                            [src]="activity.media.coverImage.large"
                            class="me-2 rounded"
                            width="50"
                            height="70"
                            style="object-fit: cover"
                            alt="{{ activity.media.title.userPreferred }}"
                          />
                          <div>
                            <div class="fw-bold">{{ activity.media.title.userPreferred }}</div>
                            <div class="text-muted">
                              {{ activity.media.format?.replace('_', ' ') }}
                            </div>
                            <div class="text-muted">{{ activity.media.startDate.year }}</div>
                          </div>
                        </div>
                      }
                      <div class="mt-3 d-flex gap-3">
                        <div class="d-flex align-items-center gap-1">
                          <div
                            class="d-flex align-items-center gap-1"
                            style="cursor: pointer"
                            [class.text-danger]="activity.isLiked"
                            [class.text-secondary]="!activity.isLiked"
                            (click)="toggleLike(activity.id)"
                          >
                            <myanili-icon
                              [name]="activity.isLiked ? 'heart-fill' : 'heart'"
                            ></myanili-icon>
                          </div>
                          @if (activity.likeCount > 0) {
                            <span
                              style="cursor: pointer"
                              (click)="toggleLikers('activity', activity.id, undefined)"
                              class="user-select-none"
                            >
                              {{ activity.likeCount }}
                            </span>
                          }
                          @if (activity.likeCount === 0) {
                            <span>0</span>
                          }
                        </div>
                        <div
                          class="d-flex align-items-center gap-1 text-secondary"
                          style="cursor: pointer"
                          (click)="toggleReplies(activity.id)"
                        >
                          <myanili-icon name="chat"></myanili-icon>
                          <span>{{ activity.replyCount }}</span>
                        </div>
                      </div>
                      @if (
                        isLikersExpanded('activity', activity.id) &&
                        activity.likes &&
                        activity.likes.length > 0
                      ) {
                        <div class="mt-2 p-2 rounded bg-secondary" style="--bs-bg-opacity: 0.1">
                          <div class="d-flex flex-wrap gap-2">
                            @for (liker of activity.likes; track liker) {
                              <img
                                [src]="liker.avatar.medium || ''"
                                class="rounded-circle"
                                width="32"
                                height="32"
                                alt="{{ liker.name }}"
                                [routerLink]="['/feed/user', liker.id]"
                                style="cursor: pointer"
                                [title]="liker.name"
                              />
                            }
                          </div>
                        </div>
                      }
                      @if (showReplies[activity.id]) {
                        <div class="mt-3">
                          @for (reply of activity.replies; track reply) {
                            <div class="mb-2 p-2 rounded bg-secondary" style="--bs-bg-opacity: 0.2">
                              <div class="d-flex">
                                <img
                                  [src]="reply.user.avatar.medium"
                                  class="rounded-circle me-2"
                                  width="32"
                                  height="32"
                                  alt="{{ reply.user.name }}"
                                  [routerLink]="['/feed', reply.user.id]"
                                  style="cursor: pointer"
                                />
                                <div class="flex-grow-1" style="min-width: 0">
                                  <div>
                                    <strong
                                      class="me-2"
                                      [routerLink]="['/feed', reply.user.id]"
                                      style="cursor: pointer"
                                    >
                                      {{ reply.user.name }}
                                    </strong>
                                    <small class="text-muted">{{
                                      formatDate(reply.createdAt)
                                    }}</small>
                                  </div>
                                  <div
                                    class="reply-text clamped"
                                    [innerHTML]="parseMarkdown(reply.text)"
                                  ></div>
                                  <div class="mt-2 d-flex align-items-center gap-1">
                                    <div
                                      class="d-flex align-items-center gap-1"
                                      style="cursor: pointer"
                                      [class.text-danger]="reply.isLiked"
                                      [class.text-secondary]="!reply.isLiked"
                                      (click)="toggleReplyLike(activity.id, reply.id)"
                                    >
                                      <myanili-icon
                                        [name]="reply.isLiked ? 'heart-fill' : 'heart'"
                                      ></myanili-icon>
                                    </div>
                                    @if (reply.likeCount > 0) {
                                      <span
                                        style="cursor: pointer"
                                        (click)="toggleLikers('reply', reply.id, activity.id)"
                                        class="user-select-none"
                                      >
                                        {{ reply.likeCount }}
                                      </span>
                                    }
                                    @if (reply.likeCount === 0) {
                                      <span>0</span>
                                    }
                                  </div>
                                  @if (
                                    isLikersExpanded('reply', reply.id) &&
                                    reply.likes &&
                                    reply.likes.length > 0
                                  ) {
                                    <div
                                      class="mt-2 p-2 rounded bg-secondary"
                                      style="--bs-bg-opacity: 0.1"
                                    >
                                      <div class="d-flex flex-wrap gap-2">
                                        @for (liker of reply.likes; track liker) {
                                          <img
                                            [src]="liker.avatar.medium || ''"
                                            class="rounded-circle"
                                            width="32"
                                            height="32"
                                            alt="{{ liker.name }}"
                                            [routerLink]="['/feed/user', liker.id]"
                                            style="cursor: pointer"
                                            [title]="liker.name"
                                          />
                                        }
                                      </div>
                                    </div>
                                  }
                                </div>
                              </div>
                            </div>
                          }
                          <div class="mt-3">
                            <textarea
                              class="form-control mb-2"
                              rows="2"
                              placeholder="Write a reply..."
                              [(ngModel)]="replyText[activity.id]"
                              style="resize: vertical"
                            ></textarea>
                            <button
                              class="btn btn-sm btn-primary"
                              (click)="postReply(activity.id)"
                              [disabled]="
                                !replyText[activity.id] ||
                                replyText[activity.id].trim().length === 0
                              "
                            >
                              Post Reply
                            </button>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }

          <div class="d-flex justify-content-between mt-4 mb-4">
            <button
              class="btn btn-outline-primary"
              (click)="previousPage()"
              [disabled]="currentPage === 1"
            >
              Previous
            </button>
            <span class="align-self-center">Page {{ currentPage }}</span>
            <button class="btn btn-outline-primary" (click)="nextPage()">Next</button>
          </div>
        </div>
      }
    </div>
  </div>
</div>
