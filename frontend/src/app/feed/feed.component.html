<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
          <span *ngIf="feedType === 'following'">Following Feed</span>
          <span *ngIf="feedType === 'user' && !userId">My Activity</span>
          <span *ngIf="feedType === 'user' && userId">User Activity</span>
        </h2>
        <div class="d-flex gap-2">
          <div class="btn-group">
            <button
              class="btn btn-sm"
              [class.btn-primary]="feedType === 'user' && !userId"
              [class.btn-outline-primary]="feedType !== 'user' || userId"
              (click)="feedType = 'user'; userId = undefined; loadFeed()"
            >
              <myanili-icon
                [name]="feedType === 'user' && !userId ? 'person-fill' : 'person'"
              ></myanili-icon>
              <span class="d-none d-md-inline">My Feed</span>
            </button>
            <button
              class="btn btn-sm"
              [class.btn-primary]="feedType === 'following'"
              [class.btn-outline-primary]="feedType !== 'following'"
              (click)="feedType = 'following'; loadFeed()"
            >
              <myanili-icon
                [name]="feedType === 'following' ? 'people-fill' : 'people'"
              ></myanili-icon>
              <span class="d-none d-md-inline">Following Feed</span>
            </button>
          </div>
          <button
            class="btn btn-sm btn-outline-primary"
            (click)="reloadFeed()"
            [disabled]="loading"
          >
            <myanili-icon name="arrow-clockwise"></myanili-icon>
            <span class="d-none d-md-inline">Reload</span>
          </button>
        </div>
      </div>

      <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <div *ngIf="!loading && activities.length === 0" class="alert alert-info">
        No activities found.
      </div>

      <div class="activities" *ngIf="!loading && activities.length > 0">
        <div class="mb-3" *ngFor="let activity of activities">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-start">
                <img
                  [src]="activity.user.avatar.large"
                  class="rounded-circle me-3"
                  width="48"
                  height="48"
                  alt="{{ activity.user.name }}"
                  [routerLink]="['/feed/user', activity.user.id]"
                  style="cursor: pointer"
                />
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <strong
                        [routerLink]="['/feed/user', activity.user.id]"
                        style="cursor: pointer"
                      >
                        {{ activity.user.name }}
                      </strong>
                      <small class="text-muted ms-2">{{ formatDate(activity.createdAt) }}</small>
                    </div>
                    <a [href]="activity.siteUrl" target="_blank" class="btn btn-sm btn-link">
                      <myanili-icon name="box-arrow-up-right"></myanili-icon>
                    </a>
                  </div>

                  <div class="mt-2 lh-base" [innerHTML]="getActivityText(activity)"></div>

                  <div
                    *ngIf="activity.media"
                    class="mt-2 p-2 bg-body-secondary rounded d-flex align-items-center"
                    [class.cursor-pointer]="activity.media.idMal"
                    (click)="navigateToMedia(activity.media)"
                    style="cursor: pointer"
                  >
                    <img
                      [src]="activity.media.coverImage.large"
                      class="me-2 rounded"
                      width="50"
                      height="70"
                      style="object-fit: cover"
                      alt="{{ activity.media.title.userPreferred }}"
                    />
                    <div>
                      <div class="fw-bold">{{ activity.media.title.userPreferred }}</div>
                      <small class="text-muted">{{ activity.media.type }}</small>
                    </div>
                  </div>

                  <div class="mt-3 d-flex gap-3">
                    <div
                      class="d-flex align-items-center gap-1"
                      style="cursor: pointer"
                      [class.text-danger]="activity.isLiked"
                      [class.text-secondary]="!activity.isLiked"
                      (click)="toggleLike(activity.id)"
                    >
                      <myanili-icon
                        [name]="activity.isLiked ? 'heart-fill' : 'heart'"
                      ></myanili-icon>
                      <span>{{ activity.likeCount }}</span>
                    </div>
                    <div
                      class="d-flex align-items-center gap-1 text-secondary"
                      style="cursor: pointer"
                      (click)="toggleReplies(activity.id)"
                    >
                      <myanili-icon name="chat"></myanili-icon>
                      <span>{{ activity.replyCount }}</span>
                    </div>
                  </div>

                  <div class="mt-3" *ngIf="showReplies[activity.id]">
                    <div
                      class="mb-2 p-2 bg-body-tertiary rounded border-start border-primary border-3"
                      *ngFor="let reply of activity.replies"
                    >
                      <div class="d-flex">
                        <img
                          [src]="reply.user.avatar.large"
                          class="rounded-circle me-2"
                          width="32"
                          height="32"
                          alt="{{ reply.user.name }}"
                          [routerLink]="['/feed', reply.user.id]"
                          style="cursor: pointer"
                        />
                        <div class="flex-grow-1">
                          <div>
                            <strong
                              class="me-2"
                              [routerLink]="['/feed', reply.user.id]"
                              style="cursor: pointer"
                            >
                              {{ reply.user.name }}
                            </strong>
                            <small class="text-muted">{{ formatDate(reply.createdAt) }}</small>
                          </div>
                          <div [innerHTML]="reply.text"></div>
                        </div>
                      </div>
                    </div>

                    <div class="mt-3">
                      <textarea
                        class="form-control mb-2"
                        rows="2"
                        placeholder="Write a reply..."
                        [(ngModel)]="replyText[activity.id]"
                        style="resize: vertical"
                      ></textarea>
                      <button
                        class="btn btn-sm btn-primary"
                        (click)="postReply(activity.id)"
                        [disabled]="
                          !replyText[activity.id] || replyText[activity.id].trim().length === 0
                        "
                      >
                        Post Reply
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between mt-4 mb-4">
          <button
            class="btn btn-outline-primary"
            (click)="previousPage()"
            [disabled]="currentPage === 1"
          >
            Previous
          </button>
          <span class="align-self-center">Page {{ currentPage }}</span>
          <button class="btn btn-outline-primary" (click)="nextPage()">Next</button>
        </div>
      </div>
    </div>
  </div>
</div>
